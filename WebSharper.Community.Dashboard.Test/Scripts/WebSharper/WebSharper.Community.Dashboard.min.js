(function(){"use strict";var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,_0,_1,_2,_3,_4,_5,_6,_7,_8,_9,_,$,ba,bb,bc,bd,be,bf,bg,bh,bi,bj,bk,bl,bm,bn,bo,bp,bq,br;a=window.WebSharper=window.WebSharper||{};b=a.Community=a.Community||{};c=b.Dashboard=b.Dashboard||{};d=c.MessageBus=c.MessageBus||{};e=d.KeyValue=d.KeyValue||{};f=d.Message=d.Message||{};g=d.AgentState=d.AgentState||{};h=window.StartupCode$WebSharper_Community_Dashboard$MessageBus=window.StartupCode$WebSharper_Community_Dashboard$MessageBus||{};i=c.InPort=c.InPort||{};j=c.OutPortType=c.OutPortType||{};k=c.OutPort=c.OutPort||{};l=c.Ports=c.Ports||{};m=c.Worker=c.Worker||{};n=c.Workers=c.Workers||{};o=c.RandomRunner=c.RandomRunner||{};p=c.OpenWeather=c.OpenWeather||{};q=p.Forecast=p.Forecast||{};r=c.OpenWeatherRunner=c.OpenWeatherRunner||{};s=c.ChartRunnerContext=c.ChartRunnerContext||{};t=c.ChartRenderer=c.ChartRenderer||{};u=c.TextBoxRenderer=c.TextBoxRenderer||{};v=c.RuleEntry=c.RuleEntry||{};w=c.RuleChain=c.RuleChain||{};x=c.RuleContainer=c.RuleContainer||{};y=c.WorkerItem=c.WorkerItem||{};z=c.Factory=c.Factory||{};A=c.WidgetItem=c.WidgetItem||{};B=c.DshData=c.DshData||{};C=c.DshEditorCellItem=c.DshEditorCellItem||{};D=c.DshEditorRowItem=c.DshEditorRowItem||{};E=c.DshEditor=c.DshEditor||{};F=c.Dashboard=c.Dashboard||{};G=a&&a.List;H=a&&a.Concurrency;I=a&&a.Remoting;J=I&&I.AjaxRemotingProvider;K=window.console;L=b&&b.Panel;M=L&&L.Helper;N=window.Date;O=window.IntelliFactory;P=O&&O.Runtime;Q=a&&a.Control;R=Q&&Q.MailboxProcessor;S=a&&a.Seq;T=a&&a.Operators;U=a&&a.UI;V=U&&U.Next;W=V&&V.Var;X=b&&b.PropertyGrid;Y=X&&X.Properties;Z=a&&a.Guid;_0=a&&a.Unchecked;_1=V&&V.Doc;_2=a&&a.Random;_3=window.Math;_4=a&&a.PrintfHelpers;_5=a&&a.Data;_6=_5&&_5.TxtRuntime;_7=window.FSharp;_8=_7&&_7.Data;_9=_8&&_8.Runtime;_=_9&&_9.IO;$=window.JSON;ba=a&&a.Arrays;bb=V&&V.View;bc=a&&a.Charting;bd=bc&&bc.Renderers;be=bd&&bd.ChartJs;bf=bc&&bc.Chart;bg=bc&&bc.Pervasives;bh=V&&V.AttrModule;bi=a&&a.Enumerator;bj=V&&V.Key;bk=V&&V.ListModel;bl=a&&a.Option;bm=L&&L.PanelContainer;bn=L&&L.LayoutManagers;bo=L&&L.Panel;bp=L&&L.TitleButton;bq=L&&L.Dialog;br=X&&X.PropertyGrid;e.New=function(bs,bt,bu){return{Key:bs,Time:bt,Value:bu};};f.Clear={$:2};g.get_empty=function(){return g.New(G.T.Empty,G.T.Empty);};g.New=function(bs,bt){return{Buffer:bs,Listeners:bt};};d.RunServerRequests=function(){var bs;H.Start((bs=null,H.Delay(function(){return H.While(function(){return true;},H.Delay(function(){return H.Bind(H.Sleep(2*1000),function(){return H.Bind(d.Agent().PostAndAsyncReply(function(bt){return{$:4,$0:bt};},null),function(bt){return H.Bind((new J.New()).Async("WebSharper.Community.Dashboard:WebSharper.Community.Dashboard.MessageBus.GetMessages:-745577628",[bt]),function(bu){G.iter(function(bv){var bw;bw=d.Agent();bw.mailbox.AddLast({$:0,$0:bv});bw.resume();},bu);K.log((function(bv){return function(bw){return bv("Values from server requested messages received:"+window.String(bw));};}(window.id))(bu.get_Length()));return H.Zero();});});});}));})),null);};d.Agent=function(){h.$cctor();return h.Agent;};d.CreateString=function(bs){return d.CreateStrPair(M.UniqueKey(),bs);};d.CreateNumber=function(bs){return d.CreateNumPair(M.UniqueKey(),bs);};d.CreateStrPair=function(bs,bt){return d.CreateKeyValue(bs,{$:1,$0:bt});};d.CreateNumPair=function(bs,bt){return d.CreateKeyValue(bs,{$:0,$0:bt});};d.CreateKeyValue=function(bs,bt){return e.New(bs,N.now(),bt);};d.Log=function(){h.$cctor();return h.Log;};d.set_Log=function(bs){h.$cctor();h.Log=bs;};h.$cctor=P.Cctor(function(){h.Log=function(){};h.Agent=R.Start(function(bs){var bt;function bu(bv){var bw;bw=null;return H.Delay(function(){return H.Bind(bs.Receive(null),function(bx){var by,bz,bA,bB,bC,bD;return bx.$==1?bu(g.New(bv.Buffer,new G.T({$:1,$0:bx.$0,$1:bv.Listeners}))):bx.$==3?(bx.$0[1](bt(bx.$0[0],bv.Buffer)),bu(bv)):bx.$==4?(bx.$0((by=bv.Buffer,by.$==0?(new N(0,0-1,0)).getTime():G.maxBy(function(bE){return bE.Time;},by).Time)),bu(bv)):bx.$==0?(bz=bx.$0,(bA=(bB=new G.T({$:1,$0:bz,$1:bv.Buffer}),g.New(bt(G.maxBy(function(bE){return bE.Time;},bB).Time-10*1000,bB),bv.Listeners)),(bC=function(bE,bF,bG){bG(bz.Value);},G.iter(function(bE){return bC(bE[0],bE[1],bE[2]);},(bD=function(bE){return bE===bz.Key;},G.filter(function(bE){return bD(bE[0],bE[1],bE[2]);},bA.Listeners))),bu(bA)))):bu(g.get_empty());});});}bt=function(bv,bw){return S.fold(function(bx,by){return by.Time>=bv?new G.T({$:1,$0:by,$1:bx}):bx;},G.T.Empty,bw);};return bu(g.get_empty());},null);h.$cctor=window.ignore;});i=c.InPort=P.Class({Equals:function(bs){return bs instanceof i&&this.Name===bs.Name;},get_StringValue:function(){var bs;bs=this;return this.ExtractPortStringValue(function(bt){return d.CreateStrPair(bs.Key,bt.c);});},get_StringVar:function(){return this.ExtractPortStringValue(window.id);},get_String:function(){return this.ExtractPortStringValue(function(bs){return bs.c;});},ExtractPortStringValue:function(bs){var bt;bt=this.PortValue;return bt.$==1?bs(bt.$0):T.FailWith("unexpected type");},get_NumberValue:function(){var bs;bs=this;return this.ExtractPortNumberValue(function(bt){return d.CreateNumPair(bs.Key,bt.c);});},get_NumberVar:function(){return this.ExtractPortNumberValue(window.id);},get_Number:function(){return this.ExtractPortNumberValue(function(bs){return bs.c;});},ExtractPortNumberValue:function(bs){var bt;bt=this.PortValue;return bt.$==0?bs(bt.$0):T.FailWith("unexpected type");},Receive:function(bs){var bt;bt=this.PortValue;bt.$==1?bs.$==1?W.Set(bt.$0,bs.$0):T.FailWith("incompatible types"):bs.$==0?W.Set(bt.$0,bs.$0):T.FailWith("incompatible types");},get_Property:function(){var bs;bs=this.PortValue;return bs.$==1?Y.string(this.Name,bs.$0):Y["double"](this.Name,bs.$0);},get_Clone:function(){var bs,bt;return i.New((bs=Z.NewGuid(),window.String(bs)),this.Name,(bt=this.PortValue,bt.$==1?{$:1,$0:W.Create$1(bt.$0.c)}:{$:0,$0:W.Create$1(bt.$0.c)}));}},null,i);i.Create=function(bs,bt,bu){return i.New(bs,bt,bu);};i.New=function(bs,bt,bu){return new i({Key:bs,Name:bt,PortValue:bu});};j=c.OutPortType=P.Class({IsCompatible:function(bs){return this.$==1?bs.PortValue.$==1&&true:bs.PortValue.$==0&&true;}},null,j);j.StringOutPort=new j({$:1});j.NumberOutPort=new j({$:0});k=c.OutPort=P.Class({Equals:function(bs){return bs instanceof k&&this.Name===bs.Name;},Trigger:function(bs){var bt;bt=d.Agent();bt.mailbox.AddLast({$:0,$0:d.CreateKeyValue(this.Key,bs)});bt.resume();},get_Clone:function(){return k.New(M.UniqueKey(),this.Name,this.Type);}},null,k);k.CreateString=function(bs,bt){return k.Create(bs,bt,j.StringOutPort);};k.CreateNumber=function(bs,bt){return k.Create(bs,bt,j.NumberOutPort);};k.Create=function(bs,bt,bu){return k.New(bs,bt,bu);};k.New=function(bs,bt,bu){return new k({Key:bs,Name:bt,Type:bu});};l.Create=function(bs){var bt;bt=function(bu,bv){var bw;bw=bv.Value;return bw.$==1?i.Create(bv.Key,bu,{$:1,$0:W.Create$1(bw.$0)}):i.Create(bv.Key,bu,{$:0,$0:W.Create$1(bw.$0)});};return G.map(function(bu){return bt(bu[0],bu[1]);},bs);};m=c.Worker=P.Class({Equals:function(bs){return bs instanceof m&&_0.Equals(this.Name,bs.Name);},get_Properties:function(){return new G.T({$:1,$0:Y.string("Name",this.Name),$1:G.map(function(bs){return bs.get_Property();},this.InPorts)});},get_Render:function(){var bs;bs=this.Renderer;return bs==null?_1.Empty():(bs.$0.WebSharper_Community_Dashboard_IRenderer$get_Render())(this);},get_CloneAndRun:function(){var bs,bt,bu;bs=W.Create$1(this.Name.c);bt=G.map(function(bv){return bv.get_Clone();},this.InPorts);bu=G.map(function(bv){return bv.get_Clone();},this.OutPorts);return m.New(M.UniqueKey(),bs,bt,bu,this.Runner,this.Renderer,this.DataContext,null).WithStartRunner();},WithStartRunner:function(){var bs;bs=this.Runner;return bs==null?this:m.New(this.Key,this.Name,this.InPorts,this.OutPorts,this.Runner,this.Renderer,this.DataContext,(bs.$0.WebSharper_Community_Dashboard_IRunner$get_Run())(this));},WithRenderer:function(bs){return m.New(this.Key,this.Name,this.InPorts,this.OutPorts,this.Runner,{$:1,$0:bs},this.DataContext,this.RunnerContext);},WithRunner:function(bs){return m.New(this.Key,this.Name,this.InPorts,this.OutPorts,{$:1,$0:bs},this.Renderer,this.DataContext,this.RunnerContext);},WithKey:function(bs){return m.New(bs,this.Name,this.InPorts,this.OutPorts,this.Runner,this.Renderer,this.DataContext,this.RunnerContext);}},null,m);m.Create=function(bs){return m.New(M.UniqueKey(),W.Create$1(bs.WebSharper_Community_Dashboard_IWorkerContext$get_Name()),bs.WebSharper_Community_Dashboard_IWorkerContext$get_InPorts(),bs.WebSharper_Community_Dashboard_IWorkerContext$get_OutPorts(),null,null,bs,null);};m.New=function(bs,bt,bu,bv,bw,bx,by,bz){return new m({Key:bs,Name:bt,InPorts:bu,OutPorts:bv,Runner:bw,Renderer:bx,DataContext:by,RunnerContext:bz});};n.allInPorts=function(bs){return n.allPorts(bs,function(bt){return bt.InPorts;});};n.allOutPorts=function(bs){return n.allPorts(bs,function(bt){return bt.OutPorts;});};n.allPorts=function(bs,bt){return G.concat(G.map(bt,bs));};o=c.RandomRunner=P.Class({WithMiddleValue:function(bs){return o.New(this.Name,d.CreateNumber(bs),this.Dispersion,this.OutPortKey);},WebSharper_Community_Dashboard_IRunner$get_Run:function(){return function(bs){var bt;new _2.New();H.Start((bt=null,H.Delay(function(){return H.While(function(){return true;},H.Delay(function(){return H.Bind(H.Sleep(600),function(){var bu,bv,bw;bu=bs.InPorts.get_Item(1).get_Number();bv=bs.InPorts.get_Item(0).get_Number();bw=_3.random()*bu+bv;bs.OutPorts.get_Item(0).Trigger({$:0,$0:bw});return H.Zero();});}));})),null);return null;};},WebSharper_Community_Dashboard_IWorkerContext$get_OutPorts:function(){return G.ofArray([k.CreateNumber(this.OutPortKey,"Random value")]);},WebSharper_Community_Dashboard_IWorkerContext$get_InPorts:function(){return l.Create(G.ofArray([["Middle value",this.MiddleValue],["Dispersion",this.Dispersion]]));},WebSharper_Community_Dashboard_IWorkerContext$get_Name:function(){return this.Name;}},null,o);o.get_FromPorts=function(){return function(bs){return o.New(bs.Name.c,bs.InPorts.get_Item(0).get_NumberValue(),bs.InPorts.get_Item(1).get_NumberValue(),bs.OutPorts.get_Item(0).Key);};};o.Create=function(bs,bt){var bu;return o.New("Random",d.CreateNumber(bs),d.CreateNumber(bt),(bu=Z.NewGuid(),window.String(bu)));};o.New=function(bs,bt,bu,bv){return new o({Name:bs,MiddleValue:bt,Dispersion:bu,OutPortKey:bv});};q.New=function(bs,bt,bu,bv,bw){return{Title:bs,Description:bt,ImageUrl:bu,Temperature:bv,TemparatureMinMax:bw};};p.get=function(bs,bt){var bu;bu=null;return H.Delay(function(){var bv;bv=(((P.Curried3(function(bw,bx,by){return bw("http://api.openweathermap.org/data/2.5/weather?q="+_4.toSafe(bx)+"&units=metric&appid="+_4.toSafe(by));}))(window.id))(bt))(bs);K.log("get key city "+bv);return H.TryWith(H.Delay(function(){return H.Bind(_6.AsyncMap(_.asyncReadTextAtRuntime(false,"C:\\Users\\Andrey\\Private\\VS_Projects\\WebSharper.Community.Dashboard\\WebSharper.Community.Dashboard","","JSON","",bv),function(bw){return _0.Equals(typeof bw,"string")?$.parse(bw):bw;}),function(bw){var bx,by,bz,bA,bB,bC,bD,bE,bF,bG,bH,bI,bJ,bK,bL,bM,bN,bO,bP,bQ,bR,bS,bT;K.log("get key city 2");return H.Return((bx=ba.tryHead(bw.weather),bx==null?null:{$:1,$0:(by=bx.$0,q.New((((P.Curried3(function(bU,bV,bW){return bU(_4.toSafe(bV)+", "+_4.toSafe(bW));}))(window.id))((bA=(bz="name",bz in bw?{$:1,$0:bw[bz]}:null),bA==null?null:bA.$0)))((bD=(bB=bw.sys,(bC="country",bC in bB?{$:1,$0:bB[bC]}:null)),bD==null?null:bD.$0)),(bF=(bE="main",bE in by?{$:1,$0:by[bE]}:null),bF==null?null:bF.$0),(function(bU){return function(bV){return bU("http://openweathermap.org/img/w/"+_4.toSafe(bV)+".png");};}(window.id))((bH=(bG="icon",bG in by?{$:1,$0:by[bG]}:null),bH==null?null:bH.$0)),(bI=(bJ=bw.main,(bK="temp",bK in bJ?{$:1,$0:bJ[bK]}:null)),(bL=bI==null?null:{$:1,$0:1*bI.$0},bL==null?null:bL.$0)),[(bM=(bN=bw.main,(bO="temp_min",bO in bN?{$:1,$0:bN[bO]}:null)),(bP=bM==null?null:{$:1,$0:1*bM.$0},bP==null?null:bP.$0)),(bQ=(bR=bw.main,(bS="temp_max",bS in bR?{$:1,$0:bR[bS]}:null)),(bT=bQ==null?null:{$:1,$0:1*bQ.$0},bT==null?null:bT.$0))]))}));});}),function(bw){K.log(bw.message);return H.Return(null);});});};r=c.OpenWeatherRunner=P.Class({WebSharper_Community_Dashboard_IRunner$get_Run:function(){return function(bs){var bt;H.Start((bt=null,H.Delay(function(){return H.While(function(){return true;},H.Delay(function(){var bu,bv,bw;bu=bs.InPorts.get_Item(0);bv=bs.InPorts.get_Item(1);bw=bs.OutPorts.get_Item(0);return H.Bind(p.get(bv.get_String(),bu.get_String()),function(bx){return H.Combine(bx==null?H.Zero():(K.log("Value generated:"+bx.$0.Title),bw.Trigger({$:0,$0:+bx.$0.Temperature}),H.Zero()),H.Delay(function(){return H.Bind(H.Sleep(1000*15),function(){return H.Return(null);});}));});}));})),null);return null;};},WebSharper_Community_Dashboard_IWorkerContext$get_OutPorts:function(){return G.ofArray([k.CreateNumber(this.OutPortKey,"Temperature")]);},WebSharper_Community_Dashboard_IWorkerContext$get_InPorts:function(){return l.Create(G.ofArray([["City",this.OpenWeatherCity],["ApiKey",this.OpenWeatherApiKey]]));},WebSharper_Community_Dashboard_IWorkerContext$get_Name:function(){return this.Name;}},null,r);r.get_FromPorts=function(){return function(bs){return r.New(bs.Name.c,bs.InPorts.get_Item(0).get_StringValue(),bs.InPorts.get_Item(1).get_StringValue(),bs.OutPorts.get_Item(0).Key);};};r.Create=function(bs,bt){var bu;return r.New("OpenWeatherMap",d.CreateString(bs),d.CreateString(bt),(bu=Z.NewGuid(),window.String(bu)));};r.New=function(bs,bt,bu,bv){return new r({Name:bs,OpenWeatherCity:bt,OpenWeatherApiKey:bu,OutPortKey:bv});};s.New=function(bs,bt){return{LineChart:bs,Queue:bt};};t=c.ChartRenderer=P.Class({WebSharper_Community_Dashboard_IRenderer$get_Render:function(){return function(bs){var bt,bu;bt=bs.InPorts.get_Item(3).get_Number()<<0;bu=bs.RunnerContext.$0;bb.Sink(function(bv){bu.Queue.push(bv);bu.Queue.length>bt?bu.Queue.shift():void 0;S.iteri(function(bw,bx){return bu.LineChart.__UpdateData(bw,function(){return bx;});},bu.Queue);},bs.InPorts.get_Item(0).get_NumberVar().v);return be.Render$8(bs.RunnerContext.$0.LineChart,{$:1,$0:{$:0,$0:bs.InPorts.get_Item(1).get_Number()<<0,$1:bs.InPorts.get_Item(2).get_Number()<<0}},null,null);};},WebSharper_Community_Dashboard_IRunner$get_Run:function(){return function(bs){var bt,bu,bv,bw;bt=bs.InPorts.get_Item(3).get_Number()<<0;bu=G.ofSeq(S.delay(function(){return S.map(function(){return 0;},T.range(0,bt-1));}));bv=(bw=[],(S.iter(function(bx){bw.push(bx);},bu),bw));return{$:1,$0:s.New(bf.Line(bu).__WithFillColor(new bg.Color({$:2,$0:"white"})),bv)};};},WebSharper_Community_Dashboard_IWorkerContext$get_OutPorts:function(){return G.T.Empty;},WebSharper_Community_Dashboard_IWorkerContext$get_InPorts:function(){return l.Create(G.ofArray([[" in Value",d.CreateNumber(0)],["cx",this.Cx],["cy",this.Cy],["BufferSize",this.ChartBufferSize]]));},WebSharper_Community_Dashboard_IWorkerContext$get_Name:function(){return this.Name;}},null,t);t.get_FromPorts=function(){return function(bs){return t.New(bs.Name.c,bs.InPorts.get_Item(0).get_NumberValue(),bs.InPorts.get_Item(1).get_NumberValue(),bs.InPorts.get_Item(2).get_NumberValue(),bs.InPorts.get_Item(3).get_NumberValue());};};t.Create=function(bs,bt,bu){return t.New("Chart",d.CreateNumber(0),d.CreateNumber(bs),d.CreateNumber(bt),d.CreateNumber(bu));};t.New=function(bs,bt,bu,bv,bw){return new t({Name:bs,Number:bt,Cx:bu,Cy:bv,ChartBufferSize:bw});};u=c.TextBoxRenderer=P.Class({WebSharper_Community_Dashboard_IRenderer$get_Render:function(){return function(bs){var bt;bt=bb.Map(function(bu){var bv;bv=bu<<0;return window.String(bv);},bs.InPorts.get_Item(0).get_NumberVar().v);return _1.Element("div",[bh.Class("bigvalue")],[_1.TextView(bt)]);};},WebSharper_Community_Dashboard_IWorkerContext$get_OutPorts:function(){return G.T.Empty;},WebSharper_Community_Dashboard_IWorkerContext$get_InPorts:function(){return l.Create(G.ofArray([["in Value",this.TextBoxValue]]));},WebSharper_Community_Dashboard_IWorkerContext$get_Name:function(){return this.Name;}},null,u);u.get_FromPorts=function(){return function(bs){return u.New(bs.Name.c,bs.InPorts.get_Item(0).get_NumberValue());};};u.get_Create=function(){return u.New("Text",d.CreateNumber(0));};u.New=function(bs,bt){return new u({Name:bs,TextBoxValue:bt});};v.New=function(bs,bt,bu){return{InPortKey:bs,OutPortKey:bt,WorkerKey:bu};};w.New=function(bs){return{RuleChain:bs};};x=c.RuleContainer=P.Class({Reconnect:function(bs){var bt,bu,bv;bt=n.allOutPorts(bs);bu=n.allInPorts(bs);G.iter(function(bw){(d.Log())((((P.Curried3(function(bx,by,bz){return bx(_4.toSafe(by)+" "+_4.toSafe(bz));}))(window.id))(bw.Name))(bw.Key));},bu);bv=d.Agent();bv.mailbox.AddLast(f.Clear);bv.resume();G.iter(function(bw){var bx,by,bz;bx=G.ofSeq(bw.RuleChain);by=G.ofSeq(T.range(1,bx.get_Length()-1));bz=bi.Get(by);try{while(bz.MoveNext())(function(){var bA,bB,bC,bD,bE,bF,bG,bH;bA=bz.Current();bB=bx.get_Item(bA-1);bC=bx.get_Item(bA);bD=S.tryFind(function(bI){return bI.Key===bB.OutPortKey;},bt),bD==null?null:{$:1,$0:(bE=bD.$0,((d.Log())((function(bI){return function(bJ){return bI("Found out port "+_4.toSafe(bJ));};}(window.id))(bC.InPortKey)),bF=S.tryFind(function(bI){return bI.Key===bC.InPortKey;},bu),bF==null?null:{$:1,$0:(bG=bF.$0,((d.Log())("Found int port"),bH=d.Agent(),bH.mailbox.AddLast({$:1,$0:[bE.Key,bE.Name+"->"+bG.Name,function(bI){bG.Receive(bI);}]}),bH.resume()))}))};}());}finally{if("Dispose"in bz)bz.Dispose();}},G.ofSeq(this.RuleContainer));}},null,x);x.New=function(bs){return new x({RuleContainer:bs});};y.Create=function(bs){return y.New(bj.Fresh(),bs);};y.New=function(bs,bt){return{Key:bs,Worker:bt};};z=c.Factory=P.Class({RegisterEvent:function(bs){this.EventItems.Append(y.Create(bs));},RegisterWidget:function(bs){this.WidgetItems.Append(y.Create(bs));}},null,z);z.get_Create=function(){return z.New(bk.Create(function(bs){return bs.Key;},G.T.Empty),bk.Create(function(bs){return bs.Key;},G.T.Empty));};z.New=function(bs,bt){return new z({EventItems:bs,WidgetItems:bt});};A.Create=function(bs,bt){return A.New(bj.Fresh(),bs,bt);};A.New=function(bs,bt,bu){return{Key:bs,Panel:bt,Widget:bu};};B=c.DshData=P.Class({RegisterWidget:function(bs,bt,bu){var bv;bv=bu.WithKey(bs);this.WidgetItems.Append(A.Create(bt,bv));this.WorkItems.Append(y.Create(bv));},RegisterEvent:function(bs,bt){var bu;bu=y.Create(bt.WithKey(bs));this.EventItems.Append(bu);this.WorkItems.Append(bu);},get_Clear:function(){this.WorkItems.Clear();this.WidgetItems.Clear();this.EventItems.Clear();}},null,B);B.get_Create=function(){return B.New(bk.Create(function(bs){return bs.Key;},G.T.Empty),bk.Create(function(bs){return bs.Key;},G.T.Empty),bk.Create(function(bs){return bs.Key;},G.T.Empty));};B.New=function(bs,bt,bu){return new B({WorkItems:bs,WidgetItems:bt,EventItems:bu});};C=c.DshEditorCellItem=P.Class({Render:function(bs,bt){var bu,bv,bw,bx,by;bu=this;bb.Sink(function(bz){var bA;if(bz==null);else{bA=bz.$0;K.log("Workitem selected");W.Set(bu.OptInPort,G.tryHead(bA.Worker.InPorts));W.Set(bu.OptOutPort,G.tryHead(bA.Worker.OutPorts));bt();}},this.OptWorker.v);bb.Sink(function(){bt();},this.OptInPort.v);bb.Sink(function(){bt();},this.OptOutPort.v);bv=(bw=bb.Map(function(bz){var bA;return bz==null?G.ofArray([null]):(bA=G.map(function(bB){return{$:1,$0:bB};},bz.$0.Worker.InPorts),bA.get_Length()>0?bA:G.ofArray([null]));},this.OptWorker.v),(bx=bb.Map(function(bz){var bA;return bz==null?G.ofArray([null]):(bA=G.map(function(bB){return{$:1,$0:bB};},bz.$0.Worker.OutPorts),bA.get_Length()>0?bA:G.ofArray([null]));},this.OptWorker.v),(by=bb.Map(function(bz){return new G.T({$:1,$0:null,$1:G.map(function(bA){return{$:1,$0:bA};},G.ofSeq(bz))});},bs.WorkItems.v),_1.Element("table",[],[_1.Element("tr",[],[_1.Element("td",[],[_1.SelectDyn([bh.Class("form-control")],function(bz){return bl.fold(function(bA,bB){return bB.Name;}," ",bz);},bw,this.OptInPort)]),_1.Element("td",[],[_1.SelectDyn([bh.Class("form-control")],function(bz){return bl.fold(function(bA,bB){return bB.Worker.Name.c;}," ",bz);},by,this.OptWorker)]),_1.Element("td",[],[_1.SelectDyn([bh.Class("form-control")],function(bz){return bl.fold(function(bA,bB){return bB.Name;}," ",bz);},bx,this.OptOutPort)])])]))));return _1.Element("td",[bh.Class("td DshEditorCell")],[_1.Element("div",[bh.Class("div DshEditorCell")],[_1.Element("table",[],[_1.Element("tr",[],[_1.Element("td",[],[bv])])])])]);}},null,C);C.get_Create=function(){return C.New(bj.Fresh(),W.Create$1(null),W.Create$1(null),W.Create$1(null));};C.New=function(bs,bt,bu,bv){return new C({Key:bs,OptInPort:bt,OptWorker:bu,OptOutPort:bv});};D=c.DshEditorRowItem=P.Class({Render:function(bs,bt){var bu;bu=this;return _1.Element("tr",[],[_1.ConvertBy(function(bv){return bv.Key;},function(bv){return bv.Render(bs,bt);},this.CellItems.v),M.IconNormal("add",function(){bu.CellItems.Append(C.get_Create());})]);}},null,D);D.Create=function(bs){return D.New(bj.Fresh(),bk.Create(function(bt){return bt.Key;},bs));};D.New=function(bs,bt){return new D({Key:bs,CellItems:bt});};E=c.DshEditor=P.Class({Render:function(bs){var bt,bu;bt=this;bu=function(){var bv;bv=G.map(function(bw){return bw.Worker;},G.ofSeq(bs.WorkItems));bt.get_CopyToRules().Reconnect(bv);};return _1.Element("table",[],[_1.ConvertBy(function(bv){return bv.Key;},function(bv){return _1.Element("tr",[],[bv.Render(bs,function(){bu();})]);},this.RowItems.v)]);},Restore:function(bs,bt){var bu,bv,bw,bx;bu=this;this.RowItems.Clear();bv=G.map(function(by){return by.Worker;},G.ofSeq(bs.WorkItems));bw=n.allOutPorts(bv);bx=n.allInPorts(bv);G.iter(function(by){var bz;bz=D.Create([]);G.iter(function(bA){var bB;bB=C.get_Create();W.Set(bB.OptWorker,S.tryFind(function(bC){return bC.Worker.Key===bA.WorkerKey;},G.ofSeq(bs.WorkItems)));W.Set(bB.OptInPort,S.tryFind(function(bC){return bC.Key===bA.InPortKey;},bx));W.Set(bB.OptOutPort,S.tryFind(function(bC){return bC.Key===bA.OutPortKey;},bw));bz.CellItems.Append(bB);},by.RuleChain);bu.RowItems.Append(bz);},bt.RuleContainer);bt.Reconnect(bv);},get_CopyToRules:function(){return x.New(G.map(function(bs){return w.New(G.map(function(bt){var bu,bv,bw;return v.New((bu=bt.OptInPort.c,bu==null?"":bu.$0.Key),(bv=bt.OptOutPort.c,bv==null?"":bv.$0.Key),(bw=bt.OptWorker.c,bw==null?"":bw.$0.Worker.Key));},G.ofSeq(bs.CellItems)));},G.ofSeq(this.RowItems)));}},null,E);E.get_Create=function(){return E.New(bk.Create(function(bs){return bs.Key;},G.T.Empty));};E.New=function(bs){return new E({RowItems:bs});};F=c.Dashboard=P.Class({get_Render:function(){var bs,bt,bu,bv,bw,bx,by;function bz(bA,bB){var bC;bC=W.Create$1(bA);return[bC,_1.Element("div",[bh.DynamicStyle("display",bb.Map(function(bD){return bD?"initial":"none";},bC.v))],[bB])];}bs=this;bt=_1.Element("table",[],[_1.ConvertBy(function(bA){return bA.Key;},function(bA){return _1.Element("tr",[],[_1.Element("i",M.AttrsClick(function(){bs.PropertyGrid.Edit(bA.Worker.get_Properties());}),[_1.TextView(bA.Worker.Name.v)])]);},this.Data.EventItems.v)]);bu=G.ofArray([["Board",bz(true,this.PanelContainer.get_Render())],["Events",bz(false,bt)],["Rules",bz(false,this.Editor.Render(this.Data))]]);bv=(bw=function(bA,bB){var bC;bC=bB[0];return _1.Element("tr",[],[_1.Element("td",[bh.DynamicStyle("Color",bb.Map(function(bD){return bD?"#FB8C00":"#7D4600";},bC.v)),bh.Style("cursor","pointer"),bh.Handler("click",function(){return function(){var bD;bs.PropertyGrid.Edit(G.T.Empty);bD=function(bE,bF){var bG;bG=bF[0];!_0.Equals(bG,bC)?W.Set(bG,false):W.Set(bG,true);};return G.iter(function(bE){return bD(bE[0],bE[1]);},bu);};})],[_1.TextNode(bA)])]);},G.map(function(bA){return bw(bA[0],bA[1]);},bu));bx=(by=function(bA,bB){return bB[1];},G.map(function(bA){return by(bA[0],bA[1]);},bu));return _1.Element("div",[],[_1.Element("table",[],[_1.Element("tr",[],[_1.Element("td",[bh.Style("vertical-align","top")],[_1.Element("table",[],S.concat([G.ofArray([_1.Element("tr",[],[_1.Element("td",[],[M.IconNormal("dehaze",function(){})])]),_1.Element("tr",[],[_1.Element("td",[],[M.IconNormal("add",function(){var bA,bB,bC,bD,bE;bA=(bu.get_Item(0))[1][0];bB=(bu.get_Item(1))[1][0];bC=(bu.get_Item(2))[1][0];bB.c?(bD=G.ofSeq(bs.Factory.EventItems),bE=W.Create$1(G.head(bD)),bs.Dialog.ShowDialog("Select source",_1.Element("div",[],[_1.Select([bh.Class("form-control")],function(bF){return bF.Worker.Name.c;},bD,bE)]),function(){var bF;bF=bE.c.Worker.get_CloneAndRun();bs.Data.RegisterEvent(M.UniqueKey(),bF);})):bA.c?bs.CreatePanel("Panel",700,null):bC.c?bs.Editor.RowItems.Append(D.Create([C.get_Create()])):void 0;})])])]),bv,G.ofArray([_1.Element("tr",[],[_1.Element("td",[],[])]),_1.Element("tr",[],[_1.Element("td",[],[this.PropertyGrid.get_Render()])])])]))]),_1.Element("td",[],bx)])]),_1.Element("div",[],[this.Dialog.get_Render()])]);},Restore:function(bs,bt,bu,bv){var bw,bx,by;bw=this;this.PanelContainer.PanelItems.Clear();this.Data.get_Clear();G.iter(function(bz){var bA;bA=bw.CreatePanel("Panel",700,{$:1,$0:bz.Key});W.Set(bA.Left,bz.Left);W.Set(bA.Top,bz.Top);},bs);bx=function(bz,bA){bw.Data.RegisterEvent(bz,bA);};G.iter(function(bz){return bx(bz[0],bz[1]);},bt);K.log("Events restored");by=function(bz,bA,bB){bw.RegisterWidget(bz,bA,S.find(function(bC){return bC.Key===bA;},G.ofSeq(bw.PanelContainer.PanelItems)).Children,bB.WithStartRunner());};G.iter(function(bz){return by(bz[0],bz[1],bz[2]);},bu);K.log("Widgets restored");this.Editor.Restore(this.Data,bv);K.log("Connectors restored");},CreatePanel:function(bs,bt,bu){var bv,bw,bx,by,bz,bA;bv=this;_1.ConvertBy(this.Data.WidgetItems.key,function(bB){return _1.Element("div",[],[_1.TextView(bB.Widget.Name.v)]);},this.Data.WidgetItems.v);bw=(bx=(by=Z.NewGuid(),window.String(by)),bu==null?bx:bu.$0);bz=bm.get_Create().WithLayoutManager(bn.StackPanelLayoutManager()).WithAttributes([bh.Style("border","1px solid white"),bh.Style("display","flex")]);bA=bo.get_Create().WithKey(bw).WithPannelAttrs([bh.Style("Width",window.String(bt)+"px"),bh.Style("position","absolute")]).WithTitleContent(_1.TextNode(bs)).WithTitleButtons(G.ofArray([bp.New("add",function(bB){var bC,bD;bC=G.ofSeq(bv.Factory.WidgetItems);bD=W.Create$1(G.head(bC));bv.Dialog.ShowDialog("Select widget",_1.Element("div",[],[_1.Select([bh.Class("form-control")],function(bE){return bE.Worker.Name.c;},bC,bD)]),function(){K.log("Dialog.IsOK");bv.RegisterWidget(M.UniqueKey(),bB.Key,bB.Children,bD.c.Worker.get_CloneAndRun());});}),bp.New("edit",function(bB){K.log("Edit");bv.PropertyGrid.Edit(G.concat(G.map(function(bC){return bC.Widget.get_Properties();},G.filter(function(bC){return bC.Panel===bB.Key;},G.ofSeq(bv.Data.WidgetItems)))));}),bp.New("clear",function(bB){bv.PanelContainer.PanelItems.Remove(bv.PanelContainer.FindPanelItem(bB));})])).WithChildPanelContainer(bz);this.PanelContainer.AddPanel(bA);return bA;},RegisterWidget:function(bs,bt,bu,bv){this.Data.RegisterWidget(bs,bt,bv);bu.AddPanel(bo.get_Create().WithTitle(false).WithPanelContent(bv.get_Render()));}},null,F);F.Create=function(bs){var bt;bt=bq.get_Create();return F.New(z.get_Create(),B.get_Create(),bs,E.get_Create(),br.get_Create(),bt);};F.New=function(bs,bt,bu,bv,bw,bx){return new F({Factory:bs,Data:bt,PanelContainer:bu,Editor:bv,PropertyGrid:bw,Dialog:bx});};}());
